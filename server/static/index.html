<!DOCTYPE html>
<html>
  <head>
    <title>AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/default.css">
    <link rel="stylesheet" href="static/dracula.css">
    <style>
      /* Center align elements inside the body */
      body {
        display: flex;
        flex-direction: column;
        align-items: center;

        margin: 0;
        font-family: Arial, sans-serif;
        background-color: #1a1a1a;
        color: #ffffff;
      }

      /* Give textboxes a dark and modern feel */
      input[type="text"] {
        background-color: #333;
        color: #fff;
        border: 1px solid #fff;
      }

      /* vertically oriented flex box with a max width of 500px */
      .chat-log {
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .human {
        font-style: italic;
      }

      /* A rounded button in a modern style */
      .submit {
        background-color: #4caf50; /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 12px;
      }
      .log {
        display: flex;
        flex-direction: row;
        border-bottom: 2px solid #303030;
        margin-bottom: 5px;
      }
      .user {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 100px;
        min-width: 100px;
        margin: 10px;
      }

      @media (max-width: 768px) { 
        .user {
          max-width: 60px;
          min-width: 60px;
        } 
    }

      .message {
        flex-grow: 1;
      }

      .cost {
        font-style: italic;
        font-size: 12px;
        color: #ff9c9c;
      }

      .cost_tokens {
        font-style: italic;
        font-size: 12px;
        color: #a9a9a9;
      }

      /* an animated spinning progress indicator*/
      .loader {
        border: 6px solid #f3f3f3; /* Light grey */
        border-top: 6px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 10px;
        height: 10px;
        animation: spin 1.5s linear infinite;
        display: inline-block;
        margin-right: 5px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      h1,
      h2,
      h3 {
        font-weight: 300;
        margin-top: 0;
        margin-bottom: 5px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        width: calc(100% - 40px)
      }

      @media (min-width: 769px) { .container { max-width: 1200px; margin: 0 auto;  padding: 20px;} }

      @media (max-width: 768px) { .container { width: calc(100% - 40px); padding: 10px;} }


      header {
        background-color: #222222;
        padding: 20px;
        box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
      }

      .logo {
        color: #ffffff;
        font-size: 24px;
        text-decoration: none;
      }

      nav {
        display: flex;
      }

      nav a {
        color: #ffffff;
        text-decoration: none;
        margin-left: 15px;
      }

      nav a:hover {
        color: #f1c40f;
      }

      /* textarea {
        width: 100%;
        resize: vertical;
      } */



      /* Reset textarea styles */
      textarea {
        width: 100%;
        box-sizing: border-box;
        resize: vertical;
        font-family: 'Arial', sans-serif;
      }

      /* Apply dark theme to the textarea */
      textarea {
        background-color: #1e1e1e;
        color: #f8f8f8;
        border: 1px solid #424242;
        border-radius: 5px;
        padding: 10px;
        width: calc(100% - 40px);
        font-size: 14px;
        line-height: 1.5;
        transition: all 0.3s ease;
      }

      /* Apply focus styles to the textarea */
      textarea:focus {
        outline: none;
        border: 1px solid #4e8cee;
        box-shadow: 0 0 3px rgba(62, 126, 235, 0.5);
      }

      /* Apply placeholder styles */
      textarea::placeholder {
        color: #888;
      }



      .content {
        margin-top: 40px;
      }

      .button {
        background-color: #030056;
        display: flex;
        padding: 10px 20px;
        font-size: 16px;
        text-decoration: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        flex-direction: row;
        width: 120px;
        margin: 0px 10px;
        height: 22px;
      }

      .button:hover {
        background-color: #18006d;
      }

      .button.danger {
        background-color: rgb(110, 0, 0);
      }
      .button.danger:hover {
        background-color: rgb(204, 0, 0);
      }

      /* Aligns text inside of a span vertically centered */
      a span {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: inherit;
      }

      .buttons {
        justify-content: center;
        display: flex;
      }

      .hidden {
        display: none;
      }
      .user-icon {
        width: 30px;
        height: 30px;
        stroke: white;
        border: 2px solid #370178;
        border-radius: 5px;
        background: #00043a;
        padding: 5px;
        margin: 0px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .copy {
        width: 27px;
        height: 27px;
        padding: 5px;
        border-radius: 5px;
        margin: 0px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .copy:hover {
        background-color: #00043a;
      }

      .radio-container {
        display: flex;
        justify-content: space-between;
        width: auto;
      }

      .radio-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin: 0px 10px;
      }

      .radio-label input {
        width: 16px;
        height: 16px;
        background-color: #23272a;
        border: 1px solid #99aab5;
        border-radius: 50%;
        appearance: none;
        cursor: pointer;
        margin-right: 5px;
      }

      .radio-label input:checked {
        border-color: #00114d;
        background-color: #00208f;
      }

      .radio-label span {
        color: #99aab5;
      }

      .radio-label input:checked + span {
        color: #ffffff;
      }

      .dark-checkbox {
        display: inline-block;
        position: relative;
        margin: 5px 10px;
      }

      .dark-checkbox input[type="checkbox"] {
        display: none;
      }

      .dark-checkbox label {
        font-size: 16px;
        padding-left: 30px;
      }

      .dark-checkbox label:before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 20px;
        height: 20px;
        border: 2px solid darkblue;
        background-color: #333;
        box-sizing: border-box;
        transition: background-color 0.3s ease;
      }
      
      .dark-checkbox input[type="checkbox"]:checked + label:before {
        background-color: darkblue;
      }

      .slider-container {
        display: flex;
        align-items: center;
        width: 200px;
        margin: 0px 0;
      }

      .slider {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 5px;
        background: #444;
        outline: none;
        border-radius: 5px;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #114b86;
        border-radius: 50%;
        cursor: pointer;
      }

      .slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #114b86;
        border-radius: 50%;
        cursor: pointer;
      }

      .slider::-ms-thumb {
        width: 20px;
        height: 20px;
        background: #1e90ff;
        border-radius: 50%;
        cursor: pointer;
      }

    </style>
    <script type="text/javascript">
            controller = null;
            web_socket = null;

            function generateRequest() {
              const chatInput = document.getElementById("chat-input");
              const chatLog = document.getElementsByClassName("chat-log")[0];
              if (chatInput.value.length > 0) {
                appendLog({ user: "user", message: chatInput.value });
                chatInput.value = "";
              }
              const messages = [];

              // Iterate through chatLog's children and add their contents to the messages array
              for (let i = 0; i < chatLog.children.length; i++) {
                const child = chatLog.children[i];
                if (child.dataset.user == "") {
                  continue;
                }
                messages.push({
                  role: child.dataset.user,
                  content: child.dataset.message,
                });
              }

              determinism = parseFloat(document.getElementById("determinism").value);
              determinism = ((100 - determinism )/ 100) * 2;
              return {
                    prompt: document.getElementById("prompt-tb").value,
                    messages: messages,
                    model: getSelectedModel(),
                    temperature: determinism,
                  };
            }

            // Calls the "chat" api with the current chat log contents and adds a new log message from the response
            async function request_chat() {
              if (controller != null) {
                return;
              }
              try {
                // Get the AbortSignal from the controller
                controller = new AbortController();
                const signal = controller.signal;

                document.getElementById("submit").classList.add("hidden");
                document.getElementById("cancel").classList.remove("hidden");
                const response = await fetch("/api/chat", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(generateRequest()),
                  signal,
                });
                const data = await response.json();

                appendLog({
                  user: "assistant",
                  message: data.message,
                  cost: data.cost_usd,
                  cost_tokens: data.cost_tokens,
                });
              } catch (error) {
                appendLog({ user: "", message: error.toString() });
              } finally {
                document.getElementById("submit").classList.remove("hidden");
                document.getElementById("cancel").classList.add("hidden");
                controller = null;
              }
            }

            async function cancel() {
              if (controller != null) {
                controller.abort();
              }

              if (web_socket != null) {
                web_socket.send("cancel");
                web_socket.close();
              }
            }

            function appendLog(data, existing) {
              const chatLog = document.getElementsByClassName("chat-log")[0];
              if (existing == null) {
                log = document.createElement("div");
              } else {
                existing = log;
                log.innerHTML = "";
              }
              log.classList.add("log");
              const user = document.createElement("div");
              log.appendChild(user);
              user.classList.add("user");
              if (data.user == "assistant") {
                user.innerHTML =
                  '<svg class="user-icon"><image href="static/robot.svg" width="100%" height="100%" /></svg>';
              } else if (data.user == "user") {
                log.classList.add("human");
                user.innerHTML =
                  '<svg class="user-icon"><image href="static/human.svg" width="100%" height="100%" /></svg>';
              } else {
                user.innerHTML = '<span class="user-icon">' + data.user + ":</span>";
              }
              if (data.cost != null) {
                const cost = document.createElement("div");
                user.appendChild(cost);
                cost.classList.add("cost");
                cost.innerHTML = formatCost(data.cost);
                log.dataset.cost = data.cost;
              }

              if (data.cost_tokens != null) {
                const cost = document.createElement("div");
                user.appendChild(cost);
                cost.classList.add("cost_tokens");
                cost.innerHTML = data.cost_tokens + " tokens";
                log.dataset.cost_tokens = data.cost_tokens;
              }

              log.dataset.user = data.user;

              const message = document.createElement("div");
              log.appendChild(message);
              message.classList.add("message");
              message.innerHTML = renderMarkdown(data.message);
              log.dataset.message = data.message;

              const copy = document.createElement("div");
              copy.classList.add("copy");
              copy.innerHTML = '<svg class=\"copy\"><image href="static/copy.svg" width="100%" height="100%" /></svg>';
              copy.addEventListener('click', copyMessage);
              log.appendChild(copy);

              if (data.user == "user") {
                const replay = document.createElement("div");
                replay.classList.add("replay");
                replay.innerHTML = '<svg class=\"copy\"><image href="static/replay.svg" width="100%" height="100%" /></svg>';
                replay.addEventListener('click', replayMessage);
                log.appendChild(replay);
              }
              if (existing == null) {
                chatLog.appendChild(log);
              }
              return log;
            }

            function roundToTwoSignificantDigits(num) {
              const magnitude = Math.floor(Math.log10(Math.abs(num)));
              const scale = Math.pow(10, magnitude - 1);
              return parseFloat((Math.round(num / scale) * scale).toPrecision(2));
            }

            function makeSvg(name) {
              var svg = document.createElement("svg");
              var img = document.createElement("image");
              img.setAttribute("href", "static/" + name + ".svg");
              img.setAttribute("width", "100%");
              img.setAttribute("height", "100%");
              svg.appendChild(img);
              svg.classList.add("user-icon");
              return svg;
            }

            function getSelectedModel() {
              radioButtons = document.getElementsByClassName("model-select");
              for (let i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                  return radioButtons[i].value;
                }
              }
              // Return null if no option is selected
              return null;
            }

            function copyMessage(event) {
              // Find the parent element with class name "log"
              var element = event.target.closest('.log');

              // Get the message from the data attribute
              var message = element.dataset.message;

              // Copy the message to clipboard
              var clipboard = navigator.clipboard;
              clipboard.writeText(message).then(function() {
                console.log('Message copied to clipboard');
              }, function(error) {
                console.error('Unable to copy message: ', error);
              });
            }

            function replayMessage(event) {
              // Find the parent element with class name "log"
              var element = event.target.closest('.log');

              // Get the message from the data attribute
              var message = element.dataset.message;

              const textarea = document.getElementById('chat-input');
              textarea.value = message;

              // Focus on the textarea
              textarea.focus();

              const chatLog = document.getElementsByClassName("chat-log")[0];
              remove = [];
              do_remove = false;
              for (let i = 0; i < chatLog.children.length; i++) {
                  const child = chatLog.children[i];
                  if (do_remove && child.classList.contains("log")) {
                    remove.push(child);
                  } else if (child == element) {
                    do_remove = true;
                    remove.push(child);
                  }
                }
              for (let i = 0; i < remove.length; i++) {
                chatLog.removeChild(remove[i]);
              }
            }

            async function submitKeyboard(event) {
              if (event.ctrlKey && event.key === 'Enter') {
                await chat();
              }
            }
            function renderMarkdown(markdown) {
              // Set highlight.js for marked renderer
              marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: function (code) {
                  return hljs.highlightAuto(code).value;
                },
                langPrefix: 'hljs ',
                pedantic: false,
                gfm: true,
                breaks: false,
                sanitize: false,
                smartLists: true,
                smartypants: false,
                xhtml: false
              });

              // Render markdown as HTML
              return marked.parse(markdown);
            }

            async function clearChat() {
              await cancel();
              const chatLog = document.getElementsByClassName("chat-log")[0];
              chatLog.innerHTML = "";
            }

            function formatCost(amount) {
              if (amount >= 1) {
                return `$${parseFloat(amount).toFixed(2)}`;
              } else {
                return `¢${roundToTwoSignificantDigits(amount * 100)}`;
              }
            }

            async function stream_chat(data) {
              const req = generateRequest();

              log = appendLog({
                  user: "assistant",
                  message: "...",
                  cost: 0,
                  cost_tokens: 0,
                });

              document.getElementById("submit").classList.add("hidden");
              document.getElementById("cancel").classList.remove("hidden");

              // Build the websocket connection string based on the current window's protocol (http vs https)
              const wsProtocol = window.location.protocol == "https:" ? "wss" : "ws";
              const ws = new WebSocket(wsProtocol + "://" + window.location.host + "/api/ws/chat");
              ws.onopen = function (event) {
                ws.send(JSON.stringify(req));
              };
              ws.onmessage = function (event) {
                if (event.data == "close") {
                  ws.close();
                  web_socket = null;
                  return;
                }
                const data = JSON.parse(event.data);
                console.log(data);

                appendLog({
                  user: "assistant",
                  message: data.message,
                  cost: data.cost_usd,
                  cost_tokens: data.cost_tokens,
                }, log);
              };
              ws.onclose = function (event) {
                console.log("Connection closed");
                web_socket = null;
                document.getElementById("submit").classList.remove("hidden");
                document.getElementById("cancel").classList.add("hidden");
              };

              // Handle connection errors
              ws.onerror = function (event) {
                console.error("Connection error: " + event);
              };

              web_socket = ws;
            }

            async function chat(){
              if (document.getElementById("do_stream").checked) {
                await stream_chat();
              } else {
                await request_chat();
              }
            }

            function toggleStream() {
              document.getElementById("do_stream").checked = !document.getElementById("do_stream").checked;
            }

            function updateDeterminism() {
              document.getElementById('determinism_label').innerHTML = document.getElementById('determinism').value + "%";
            }


            window.addEventListener('DOMContentLoaded', () => {
              const textarea = document.getElementById('chat-input');
              if (textarea) {
                textarea.focus();
              }
              updateDeterminism();
            });
    </script>
  </head>
  <body>
    <header>
      <h1>AI Chat</h1>
    </header>
    <div class="container prompt">
      <h3>Prompt</h3>
      <textarea
        class="chat-input"
        id="prompt-tb"
        rows="2"
        placeholder="You can enter anything here, its instructions about what the AI should be.  The default is to be a helpful assistant."
      ></textarea>
    </div>
    <div class="radio-container container">
      <label class="radio-label">
        <input
          class="model-select"
          type="radio"
          name="option"
          value="gpt-3.5-turbo"
        />
        <span>GPT3.5 ($)</span>
      </label>
      <label class="radio-label">
        <input
          class="model-select"
          type="radio"
          name="option"
          value="gpt-4"
          checked
        />
        <span>GPT4 ($$$)</span>
      </label>

      <div class="dark-checkbox" onclick="toggleStream()">
        <input type="checkbox" id="do_stream" checked>
        <label for="myCheckbox">Stream</label>
      </div>
      <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <span>
          Determinism <span id="determinism_label">50%</span>
        </span>
        <div class="slider-container">
          <input id="determinism" type="range" class="slider" min="0" max="100" step="1" oninput="updateDeterminism()" onchange="updateDeterminism()"/>
        </div>
      </div>
      
    </div>
    <div class="container chat-log"></div>
    <div class="container">
      <textarea
        class="chat-input"
        rows="4"
        placeholder="Start the conversation here"
        id="chat-input"
        onkeydown="submitKeyboard(event)"
      ></textarea>
    </div>
    <div class="container buttons">
      <a id="submit" class="button" onclick="chat()">
        <span> Submit </span>
      </a>
      <a id="cancel" class="hidden button" onclick="cancel()">
        <div class="loader"></div>
        <span> Cancel </span>
      </a>
      <a id="clear_chat" class="button danger" onclick="clearChat()">
        <span> Clear Chat </span>
      </a>
    </div>
  </body>
</html>
